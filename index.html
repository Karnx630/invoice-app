<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    
    <!-- PWA Setup for Offline Support -->
    <meta name="theme-color" content="#1a73e8">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Invoice%20Generator%22,%22short_name%22:%22Invoicer%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#1a73e8%22}">

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .setup-panel { max-width: 950px; margin: 0 auto 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .invoice-container { max-width: 900px; margin: auto; background: white; padding: 40px; border: 1px solid #ddd; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; }
        
        .religious-header { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 20px; color: red; } 
        
        /* Estimate Small Text Top Right */
        .estimate-label {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            border: 1px solid #ccc;
            padding: 2px 6px;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; table-layout: fixed; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; word-wrap: break-word; }
        th { background-color: #003366; color: white; border-color: #000; }
        
        .shipping-row { text-align: right; padding: 8px; border: 1px solid #000; border-top: none; font-size: 14px; display: none; }
        .total-box { text-align: right; font-size: 20px; font-weight: bold; padding: 10px; border: 1px solid #000; border-top: none; }
        .footer-note { margin-top: 30px; font-size: 14px; border-top: 1px dashed #ccc; padding-top: 10px; display: none; }

        .input-row { display: flex; gap: 10px; background: #eef3f7; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 13px; color: #333; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
        
        .radio-group { display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: normal; font-size: 14px; }

        .edit-table input { width: 95%; border: 1px solid #ddd; padding: 4px; text-align: center; }
        .btn-add { background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .action-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-preview { background: #ff9800; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 18px; flex: 1; font-weight: bold; }
        .btn-print { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 18px; flex: 1; font-weight: bold; }
        .btn-clear { background: #dc3545; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        #saveStatus { font-size: 12px; color: #28a745; font-weight: bold; }

        @media print { 
            .setup-panel { display: none; } 
            .invoice-container { display: block !important; border: none; padding: 0; box-shadow: none; margin: 0; } 
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>

<div class="setup-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">Generator</h2>
        <span id="saveStatus">✔ Saved Locally</span>
    </div>
    
    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
        <div class="input-group">
            <label>Type:</label>
            <div class="radio-group">
                <label><input type="radio" name="docType" value="invoice" checked onchange="saveAll()"> Invoice</label>
                <label><input type="radio" name="docType" value="estimate" onchange="saveAll()"> Estimate</label>
            </div>
        </div>
        <div class="input-group" style="flex: 1;">
            <label>Customer Name:</label>
            <input type="text" id="client" placeholder="Customer Name" oninput="saveAll()">
        </div>
        <div class="input-group">
            <label>Date:</label>
            <input type="date" id="invDate" oninput="saveAll()">
        </div>
    </div>

    <div class="input-row">
        <div class="input-group" style="flex: 2;">
            <label>Item</label><input type="text" id="t-desc">
        </div>
        <div class="input-group" style="width: 50px;">
            <label>Qty</label><input type="number" id="t-qty">
        </div>
        <div class="input-group" style="width: 70px;">
            <label>Len</label><input type="number" id="t-len">
        </div>
        <div class="input-group" style="width: 70px;">
            <label>Wid</label><input type="number" id="t-wid">
        </div>
        <div class="input-group" style="width: 90px;">
            <label>Rate</label><input type="number" id="t-rate">
        </div>
        <button class="btn-add" onclick="addItem()">Add</button>
    </div>

    <table class="edit-table">
        <tbody id="editBody"></tbody>
    </table>

    <div style="display: flex; gap: 20px; margin-top: 20px;">
        <div class="input-group">
            <label>Shipping Charge:</label>
            <input type="number" id="shippingCharge" placeholder="0" oninput="saveAll()">
        </div>
        <div class="input-group" style="flex: 1;">
            <label>Note:</label>
            <input type="text" id="footerNoteInput" oninput="saveAll()">
        </div>
    </div>

    <div class="action-row">
        <button class="btn-preview" onclick="previewInvoice()">Preview</button>
        <button class="btn-print" onclick="printInvoice()">Print PDF</button>
        <button class="btn-clear" onclick="confirmClear()">Clear All</button>
    </div>
</div>

<div id="invoice" class="invoice-container">
    <div id="estimateFlag" class="estimate-label">Estimate</div>
    <div class="religious-header">।। श्री गणेशाय नम ।।</div>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div><strong>BILLED TO:</strong><br><span id="outClient"></span></div>
        <div style="text-align: right;"><strong>DATE:</strong><br><span id="outDate"></span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40px;">Sr.</th>
                <th>Description</th>
                <th style="width: 50px;">Qty</th>
                <th style="width: 50px;">Len</th>
                <th style="width: 50px;">Wid</th>
                <th style="width: 80px;">S.F/R.F</th>
                <th style="width: 80px;">Rate</th>
                <th style="width: 100px;">Total (₹)</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="shippingRow" class="shipping-row">
        Shipping Charge: ₹ <span id="outShipping">0.00</span>
    </div>

    <div class="total-box">
        GRAND TOTAL: ₹ <span id="outTotal">0.00</span>
    </div>

    <div id="noteBox" class="footer-note">
        <strong>Note:</strong> <span id="noteContent"></span>
    </div>
</div>

<script>
    // --- OFFLINE SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                const CACHE_NAME = 'invoice-v2';
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./'])));
                });
                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                });
            `;
            const blob = new Blob([swCode], {type: 'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        });
    }

    let items = [];

    window.onload = () => {
        const saved = localStorage.getItem('inv_data_v2');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('client').value = data.client || '';
            document.getElementById('invDate').value = data.date || '';
            document.getElementById('footerNoteInput').value = data.note || '';
            document.getElementById('shippingCharge').value = data.shipping || '';
            items = data.items || [];
            if (data.docType) {
                document.querySelector(\`input[value="\${data.docType}"]\`).checked = true;
            }
            renderEditTable();
        }
    };

    function saveAll() {
        const data = {
            client: document.getElementById('client').value,
            date: document.getElementById('invDate').value,
            note: document.getElementById('footerNoteInput').value,
            shipping: document.getElementById('shippingCharge').value,
            docType: document.querySelector('input[name="docType"]:checked').value,
            items: items
        };
        localStorage.setItem('inv_data_v2', JSON.stringify(data));
    }

    function addItem() {
        const desc = document.getElementById('t-desc').value;
        const qty = parseFloat(document.getElementById('t-qty').value) || 0;
        const len = parseFloat(document.getElementById('t-len').value) || 0;
        const wid = parseFloat(document.getElementById('t-wid').value) || 0;
        const rate = parseFloat(document.getElementById('t-rate').value) || 0;
        if(!desc) return;
        items.push({ desc, qty, len, wid, rate });
        renderEditTable();
        saveAll();
        document.getElementById('t-desc').value = '';
        document.getElementById('t-desc').focus();
    }

    function renderEditTable() {
        const tbody = document.getElementById('editBody');
        tbody.innerHTML = '';
        items.forEach((item, i) => {
            tbody.innerHTML += `<tr>
                <td>\${item.desc}</td>
                <td style="width:40px;"><button onclick="items.splice(\${i},1);renderEditTable();saveAll();">X</button></td>
            </tr>`;
        });
    }

    function generate() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        let sub = 0;
        items.forEach((item, i) => {
            const q = item.qty || 1;
            let meas = 0;
            let unit = "Sf";
            if(item.len > 0 && item.wid > 0) meas = item.len * item.wid * q;
            else if(item.len > 0) { meas = item.len * q; unit = "Rf"; }
            else { meas = q; unit = "Qty"; }
            
            const amt = meas * item.rate;
            sub += amt;
            tbody.innerHTML += \`<tr>
                <td>\${i+1}</td>
                <td style="text-align:left;">\${item.desc}</td>
                <td>\${item.qty || '-'}</td>
                <td>\${item.len || '-'}</td>
                <td>\${item.wid || '-'}</td>
                <td>\${meas.toFixed(2)} \${unit}</td>
                <td>\${item.rate}</td>
                <td>\${amt.toLocaleString('en-IN')}</td>
            </tr>\`;
        });

        const ship = parseFloat(document.getElementById('shippingCharge').value) || 0;
        document.getElementById('shippingRow').style.display = ship > 0 ? 'block' : 'none';
        document.getElementById('outShipping').innerText = ship.toLocaleString('en-IN');
        
        document.getElementById('outTotal').innerText = (sub + ship).toLocaleString('en-IN');
        document.getElementById('outClient').innerText = document.getElementById('client').value;
        document.getElementById('outDate').innerText = document.getElementById('invDate').value;
        
        const note = document.getElementById('footerNoteInput').value;
        document.getElementById('noteBox').style.display = note ? 'block' : 'none';
        document.getElementById('noteContent').innerText = note;

        const isEstimate = document.querySelector('input[name="docType"]:checked').value === 'estimate';
        document.getElementById('estimateFlag').style.display = isEstimate ? 'block' : 'none';
        return true;
    }

    function previewInvoice() { generate(); document.getElementById('invoice').style.display = 'block'; }
    function printInvoice() { generate(); window.print(); }
    function confirmClear() { if(confirm("Clear all data?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>

