<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .setup-panel { max-width: 950px; margin: 0 auto 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .invoice-container { max-width: 900px; margin: auto; background: white; padding: 40px; border: 1px solid #ddd; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* HEADER STYLES */
        .religious-header { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 20px; color: red; } 
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; table-layout: fixed; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; word-wrap: break-word; }
        th { background-color: #003366; color: white; border-color: #000; }
        
        .total-box { margin-top: 20px; text-align: right; font-size: 20px; font-weight: bold; padding: 10px; border-top: 2px solid #000; }
        .footer-note { margin-top: 30px; font-size: 14px; border-top: 1px dashed #ccc; padding-top: 10px; display: none; }

        /* INPUT AREA STYLES */
        .input-row { display: flex; gap: 10px; background: #eef3f7; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 13px; color: #333; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
        
        /* EDITABLE TABLE STYLES */
        .edit-table input { width: 95%; border: 1px solid #ddd; padding: 4px; text-align: center; border-radius: 3px; }
        .edit-table input:focus { border-color: #1a73e8; outline: none; background: #fffdf0; }
        .btn-add { background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* ACTION BUTTONS */
        .action-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-preview { background: #ff9800; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 18px; flex: 1; font-weight: bold; min-width: 150px; }
        .btn-print { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 18px; flex: 1; font-weight: bold; min-width: 150px; }
        .btn-clear { background: #dc3545; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-size: 16px; flex: 0.5; font-weight: bold; min-width: 120px; }
        
        #saveStatus { font-size: 12px; color: #28a745; font-weight: bold; margin-left: 10px; }

        @media print { 
            .setup-panel { display: none; } 
            .invoice-container { display: block !important; border: none; padding: 0; box-shadow: none; margin: 0; } 
            body { background: white; padding: 0; }
            th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="setup-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">Invoice Generator</h2>
        <span id="saveStatus">‚úî Auto-saved</span>
    </div>
    
    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
        <div class="input-group" style="flex: 1; min-width: 250px;">
            <label>Customer Name:</label>
            <input type="text" id="client" placeholder="e.g. Mr. Sharma" oninput="saveAllData()">
        </div>
        <div class="input-group">
            <label>Date:</label>
            <input type="date" id="invDate" oninput="saveAllData()">
        </div>
    </div>

    <div class="input-row">
        <div class="input-group" style="flex: 2; min-width: 150px;">
            <label>Item Description</label>
            <input type="text" id="t-desc" placeholder="e.g. Plywood">
        </div>
        <div class="input-group" style="width: 60px;">
            <label>Qty</label>
            <input type="number" id="t-qty" placeholder="1">
        </div>
        <div class="input-group" style="width: 80px;">
            <label>Length</label>
            <input type="number" id="t-len" placeholder="0">
        </div>
        <div class="input-group" style="width: 80px;">
            <label>Width</label>
            <input type="number" id="t-wid" placeholder="0">
        </div>
        <div class="input-group" style="width: 100px;">
            <label>Rate</label>
            <input type="number" id="t-rate" placeholder="0">
        </div>
        <button class="btn-add" onclick="addItem()">+ Add</button>
    </div>

    <h3 style="margin: 10px 0;">Added Items (Auto-saves on change)</h3>
    <table class="edit-table">
        <thead>
            <tr style="background: #eee;">
                <th style="width: 40px; color:black; background:#eee;">#</th>
                <th style="color:black; background:#eee;">Description</th>
                <th style="width: 60px; color:black; background:#eee;">Qty</th>
                <th style="width: 70px; color:black; background:#eee;">Len</th>
                <th style="width: 70px; color:black; background:#eee;">Wid</th>
                <th style="width: 90px; color:black; background:#eee;">Rate</th>
                <th style="width: 50px; color:black; background:#eee;">Del</th>
            </tr>
        </thead>
        <tbody id="editBody"></tbody>
    </table>

    <div class="input-group" style="margin-top: 20px;">
        <label>Bottom Note (Optional):</label>
        <input type="text" id="footerNoteInput" placeholder="e.g. Goods once sold will not be returned." oninput="saveAllData()">
    </div>

    <div class="action-row">
        <button class="btn-preview" onclick="previewInvoice()">üëÅÔ∏è Preview Invoice</button>
        <button class="btn-print" onclick="printInvoice()">üñ®Ô∏è Print / Save PDF</button>
        <button class="btn-clear" onclick="confirmClear()">üóëÔ∏è New Invoice</button>
    </div>
</div>

<!-- INVOICE PREVIEW SECTION -->
<div id="invoice" class="invoice-container">
    <div class="religious-header">‡•§‡•§ ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ ‡•§‡•§</div>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div><strong>BILLED TO:</strong><br><span id="outClient"></span></div>
        <div style="text-align: right;"><strong>DATE:</strong><br><span id="outDate"></span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40px;">Sr.</th>
                <th>Description</th>
                <th style="width: 50px;">Qty</th>
                <th style="width: 60px;">Len</th>
                <th style="width: 60px;">W/H</th>
                <th style="width: 80px;">Total S.F/R.F</th>
                <th style="width: 80px;">Rate</th>
                <th style="width: 100px;">Amount (‚Çπ)</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="total-box">
        GRAND TOTAL: ‚Çπ <span id="outTotal">0.00</span>
    </div>

    <div id="noteBox" class="footer-note">
        <strong>Note:</strong> <span id="noteContent"></span>
    </div>
</div>

<script>
    let items = [];

    // --- 1. INITIAL LOAD ---
    window.onload = () => {
        const savedData = localStorage.getItem('invoice_app_data');
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById('client').value = data.client || '';
            document.getElementById('invDate').value = data.date || new Date().toISOString().split('T')[0];
            document.getElementById('footerNoteInput').value = data.note || '';
            items = data.items || [];
            renderEditTable();
        } else {
            document.getElementById('invDate').valueAsDate = new Date();
        }
    };

    // --- 2. PERSISTENCE LOGIC ---
    function saveAllData() {
        const dataToSave = {
            client: document.getElementById('client').value,
            date: document.getElementById('invDate').value,
            note: document.getElementById('footerNoteInput').value,
            items: items
        };
        localStorage.setItem('invoice_app_data', JSON.stringify(dataToSave));
        
        // Update visual status
        const status = document.getElementById('saveStatus');
        status.innerText = "Saving...";
        status.style.color = "orange";
        setTimeout(() => {
            status.innerText = "‚úî Auto-saved";
            status.style.color = "#28a745";
        }, 400);
    }

    function confirmClear() {
        if(confirm("Start a new invoice? This will clear all current entries.")) {
            localStorage.removeItem('invoice_app_data');
            location.reload();
        }
    }

    // --- 3. DATA MANAGEMENT ---
    function addItem() {
        const desc = document.getElementById('t-desc').value;
        const qtyRaw = document.getElementById('t-qty').value;
        const qty = qtyRaw === "" ? 0 : parseFloat(qtyRaw); 
        const len = parseFloat(document.getElementById('t-len').value) || 0;
        const wid = parseFloat(document.getElementById('t-wid').value) || 0;
        const rate = parseFloat(document.getElementById('t-rate').value) || 0;

        if(!desc) { alert("Please enter a description"); return; }

        items.push({ desc, qty, len, wid, rate });
        renderEditTable();
        saveAllData(); // Save after list change

        // Clear top inputs
        document.getElementById('t-desc').value = '';
        document.getElementById('t-qty').value = '';
        document.getElementById('t-len').value = '';
        document.getElementById('t-wid').value = '';
        document.getElementById('t-rate').value = '';
        document.getElementById('t-desc').focus();
    }

    function renderEditTable() {
        const tbody = document.getElementById('editBody');
        tbody.innerHTML = '';
        items.forEach((item, index) => {
            tbody.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td><input type="text" value="${item.desc}" oninput="updateItem(${index}, 'desc', this.value)" style="text-align:left;"></td>
                    <td><input type="number" value="${item.qty || ''}" placeholder="1" oninput="updateItem(${index}, 'qty', this.value)"></td>
                    <td><input type="number" value="${item.len || ''}" oninput="updateItem(${index}, 'len', this.value)"></td>
                    <td><input type="number" value="${item.wid || ''}" oninput="updateItem(${index}, 'wid', this.value)"></td>
                    <td><input type="number" value="${item.rate}" oninput="updateItem(${index}, 'rate', this.value)"></td>
                    <td><button onclick="removeItem(${index})" style="background:none; border:none; color:red; cursor:pointer; font-weight:bold;">X</button></td>
                </tr>`;
        });
    }

    function updateItem(index, key, val) {
        items[index][key] = key === 'desc' ? val : (val === "" ? 0 : parseFloat(val));
        saveAllData(); // Save while editing inline
    }

    function removeItem(index) {
        items.splice(index, 1);
        renderEditTable();
        saveAllData(); // Save after delete
    }

    // --- 4. GENERATION LOGIC ---
    function generateInvoiceHTML() {
        if(items.length === 0) { alert("Add at least one item!"); return false; }

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        let grandTotal = 0;

        items.forEach((item, index) => {
            const effectiveQty = item.qty > 0 ? item.qty : 1;
            let totalMeasurable = 0;
            let displayMeasurable = ""; 
            let amount = 0;

            if (item.len > 0 && item.wid > 0) {
                totalMeasurable = item.len * item.wid * effectiveQty; 
                displayMeasurable = totalMeasurable.toFixed(2) + " Sf"; 
                amount = totalMeasurable * item.rate;
            } 
            else if (item.len > 0 && (item.wid === 0 || isNaN(item.wid))) {
                totalMeasurable = item.len * effectiveQty; 
                displayMeasurable = totalMeasurable.toFixed(2) + " Rf"; 
                amount = totalMeasurable * item.rate;
            } 
            else {
                displayMeasurable = "-"; 
                amount = effectiveQty * item.rate;
            }

            grandTotal += amount;

            tableBody.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align:left;">${item.desc}</td>
                    <td>${item.qty > 0 ? item.qty : '--'}</td>
                    <td>${item.len > 0 ? item.len : '--'}</td>
                    <td>${item.wid > 0 ? item.wid : '--'}</td>
                    <td style="font-weight:bold;">${displayMeasurable}</td>
                    <td>${item.rate.toLocaleString('en-IN')}</td>
                    <td>${amount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                </tr>`;
        });

        document.getElementById('outClient').innerText = document.getElementById('client').value;
        const dateVal = document.getElementById('invDate').value;
        const dateObj = dateVal ? new Date(dateVal) : new Date();
        document.getElementById('outDate').innerText = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
        document.getElementById('outTotal').innerText = grandTotal.toLocaleString('en-IN', {minimumFractionDigits: 2});

        const note = document.getElementById('footerNoteInput').value;
        if(note.trim()) {
            document.getElementById('noteBox').style.display = 'block';
            document.getElementById('noteContent').innerText = note;
        } else {
            document.getElementById('noteBox').style.display = 'none';
        }
        return true;
    }

    function previewInvoice() {
        if(generateInvoiceHTML()) {
            const invoiceDiv = document.getElementById('invoice');
            invoiceDiv.style.display = 'block';
            invoiceDiv.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function printInvoice() {
        if(generateInvoiceHTML()) {
            document.getElementById('invoice').style.display = 'block';
            setTimeout(() => { window.print(); }, 500);
        }
    }
</script>
</body>
</html>